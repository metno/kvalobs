#! /bin/sh 

# PKG-INSTALL blir kalt av mipkg-install.
# Katalogen vi står i er samme katalog som
# .mipkg er. Alle filene skal legges inn
# med denne katalogen som root katalog.
# 
# PKG-INSTALL blir kalt på følgende måte:
#
#   PKG-INSTALL pathTilPakke'
#
#   pathTilPakke er topp katalogen til pakken 
#   som installeres. 
#

#Turn of filname globbing in variables
#set -f

echo "Dette er ($1) PKG-INNSTALL filen!"

pkg=$1

if [ ! -d $pkg ]; then
    echo "FATAL: PKG-INSTALL ble ikke kalt med en"
    echo "       gyldig referanse til pakken som"
    echo "       er under instalering!"
    
    exit 1
fi


function basename()
{
    local S=$IFS
    IFS="/"
    
    local bname=""
    local fname=""
    
    for f in $1 ; do
	if [ -z "$f" ]; then
	    continue
	fi
	
	if [ -z "$fname" ]; then
	    fname="$f"
	    continue
	fi
	
	bname="$fname"
	fname="$fname/$f"
    done
    
    echo "$bname"
    IFS=$S;
}

function targetname()
{
    local S=$IFS
    IFS="/"
    
	local prog=""
    
    for f in $1 ; do
		if [ -z "$f" ]; then
	    	continue
		fi
	
		prog="$f"
    done
    
    echo "$prog"
    IFS=$S;
}

function elipses()
{
    local S=$IFS
    IFS="/"
    
    local e=""
    
    for f in $1 ; do
		if [ -z "$f" ]; then
	    	continue
		fi
	
		if [ -z "$e" ]; then
	    	e=".."
		else
	    	e="$e/.."
		fi
    done
    
    if [ -z "$e" ]; then
    	e="."
    fi
    
    echo "$e"
    IFS=$S;
}

function createlink()
{
    local f=$2
    local pkg=$1
    local base=$(basename $f)
    local file=$(targetname $f)
    local el=$(elipses $base);
    local rootdir=$(pwd)

    if [ -e $f ]; then
		if [ -L $f -o -f $f ]; then
	    	rm -f $f || return 1
	    elif [ -d $f ]; then
	    	if [ -d $pkg/$f ]; then
	    		return 0
	    	elif [ -f $pkg/$f ]; then
	    		rm -rf $f || return 1
	    	else
	    		return 0
	    	fi 
	    else
	    	echo "FATAL: $f eksisterer kan ikke fjerne den!"
	    	return 1
	    fi	
    fi
    
    if [ -d $pkg/$f ]; then
    	if mkdir -p $f ; then
    		return 0
    	else
    		return 1
    	fi
    fi
    
    if [ -n "$base" ]; then
		if [ -e $base ]; then
	    	if [ ! -d $base ]; then
				echo "WARNING: $base eksiterer og er ikke en katalog!"
				if ! rm -f $base ; then
		    		echo "FATAL: Kan ikke fjerne filen <$rootdir/$base>!"
		    		return 1
				fi
		
				echo "Fjernet filen <$base>!"
				mkdir -p $base
	    	fi
		else
	    	mkdir -p $base
		fi
	
		cd $base
        
		if [ "$?" -ne 0 ]; then
	    	echo "FATAL: Kan ikke flytte til katalogen <$base>!"
	    	return 1
		fi
    fi
    
    if ! ln -s $el/$pkg/$f ; then 
		echo "FATAL: Kan ikke opprette linken:"
		echo "       <$el/$pkg/$f> i katalogen <$rotdir/$base>!"
	
		return 1
    fi

	#  echo "$(pwd) --> $el/$pkg/$f"    
    
    if ! cd $rootdir ; then
		echo "FATAL: Kan ikke flyttetilbake til katalogen:"
		echo "       <$rootdir>!"
	
		return 1
    fi

    return 0
}


#Det følgende kan se rart ut, men *, ?, og [ blir ekspandet
#med filnavn fra katalogen vi står i. Dette er noe
#vi ønsker, men det skal ekspanderes fra katalogen $pkg

files=""
TOP=$(pwd)
cd $pkg
myfiles=$(cat mipkg/files)

for ff in $myfiles ; do
    files="$files $ff"
done

cd $TOP

for f in $files ; do
    if [ -f $pkg/$f -o -L $pkg/$f ]; then
		echo "F $f"
		createlink $pkg $f
	
		if [ "$?" -ne 0 ]; then 
	    	exit 1
		fi
    elif [ -d $pkg/$f ]; then
		echo "D $f"
		createlink $pkg $f
	
		if [ "$?" -ne 0 ]; then 
	    	exit 1
		fi
    else
		echo "U $f"
    fi
done


exit 0
