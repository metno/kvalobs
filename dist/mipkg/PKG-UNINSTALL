#! /bin/sh

# PKG-UIINSTALL blir kalt av mipkg-install og mipkg-rollback.
# Katalogen vi står i er samme katalog som
# .mipkg er. Alle filene skal fjernes
# med denne katalogen som rootkatalog.
# 
# PKG-UNINSTALL blir kalt på følgende måte:
#
#   PKG-UNINSTALL pathTilPakke'
#
#   pathTilPakke er topp katalogen til pakken 
#   som installeres. 
#

echo "Dette er ($1) PKG-UNINSTALL skriptet!!!"

pkg=$1

if [ ! -d $pkg ]; then
    echo "FATAL: PKG-UNINSTALL ble ikke kalt med en"
    echo "       gyldig referanse til pakken som"
    echo "       er under instalering!"
    
    exit 1
fi


function basename()
{
    local S=$IFS
    IFS="/"
    
    local bname=""
    local fname=""
    
    for f in $1 ; do
		if [ -z "$f" ]; then
	    	continue
		fi
	
		if [ -z "$fname" ]; then
	    	fname="$f"
	    	continue
		fi
	
		bname="$fname"
		fname="$fname/$f"
    done
    
    echo "$bname"
    IFS=$S;
}

function targetname()
{
    local S=$IFS
    IFS="/"
    
    local prog=""
    
    for f in $1 ; do
		if [ -z "$f" ]; then
	    	continue
		fi
	
		prog="$f"
    done
    
    echo "$prog"
    IFS=$S;
}


function removelink()
{
    local f="$1"
    local base=$(basename $f)

	if [ -d "$f" ]; then
		#Slett katalogen hvis den er tom
		rmdir -p "$f" > /dev/null 2>&1
		return 0
	fi

	#echo "removelink: pwd($(pwd)) base($base) f($f)"

    if [ -L "$f" -o -f "$f" ]; then
    	#echo "removelink: Link or file pwd($(pwd)) ($f)"
		if rm -f "$f" ; then 
			return 0
		else
			return 1
		fi
    fi

	#Slett katalogen base hvis den er tom
	if [ -d "$base" ]; then
    	rmdir -p "$base" > /dev/null 2>&1
    fi

    return 0
}


#Det følgende kan se rart ut, men *, ?, og [ blir ekspandet
#med filnavn fra katalogen vi står i. Dette er noe
#vi ønsker, men det skal ekspanderes fra katalogen $pkg

files=""
TOP=$(pwd)

if ! cd $pkg ; then
	echo "Kan ikke skifte katalog til <$pkg>!"
	return 1
fi

myfiles="$(cat mipkg/files)"

for ff in $myfiles ; do
    files="$files $ff"
done

cd $TOP

for f in $files ; do
    if [ -f $pkg/$f ]; then
		echo "F $f"
		
		removelink $f
	
		if [ "$?" -ne 0 ]; then 
	    	exit 1
		fi
    elif [ -d $pkg/$f ]; then
		echo "D $f"
		removelink $f
	
		if [ "$?" -ne 0 ]; then 
	    	exit 1
		fi
    else
		echo "U $f"
    fi
done



exit 0
