#! /bin/sh

if [ -z "$MIPKG_PATH" ]; then
        MIPKG_PATH=$HOME
fi

mipkgdir=${MIPKG_PATH}/.mipkg

function use(){
    echo "  Bruk:"
    echo "     mipkg-install <pakkefil>"
    echo ""
    echo "    - pakkefile er en tar-fil p� v�rt pakkeformat!"
    echo " "
    exit 1
}



if [ $# -eq 0 ]; then
    use;
fi

if [ ! -d "$mipkgdir" ]; then
    if ! mkdir -p "$mipkgdir" ; then
	echo "Kan ikke opprette katalogen <.mipkg>!!!"
	exit 1
    fi
fi

TOP=$(pwd)

rm -rf $mipkgdir/tmp

if ! mkdir -p $mipkgdir/tmp ; then
    echo "Kan ikke opprette katalogen <.mipkg/tmp>!!!"
    exit 1
fi


if ! cd $mipkgdir/tmp ; then
    echo "Kan ikke skifte katalog til $mipkgdir/tmp!"
    exit 1
fi

tar zxpf "$TOP"/$1 > /dev/null 2>&1

if [ "$?" -ne 0 ]; then
    echo
    echo "  FATAL: Kan ikke pakke ut <$1>!"
    echo
    exit 1
fi

pkgname=`ls -1`

echo "pakkenavn <$pkgname>" 
pkgfiles="VERSION NAME mipkg/PKG-INSTALL mipkg/PKG-ROLLBACK \
          mipkg/PKG-UNINSTALL"

echo "Sjekker pakken!"
ok="true"

if ! cd $pkgname ; then
    echo 
    echo " Fatal kan ikke skifte katalog til <.mipkg/tmp/$pkgname>!"
    echo
    exit 1
fi

for file in $pkgfiles ; do
    if [ -f $file ]; then
		echo "$file  .... OK!"
    else
		ok="false"
		echo "$file  .... MISSING!"
    fi
done

if [ "$ok" = "false" ]; then
    echo 
    echo "  FATAL: Ugyldig pakkeformat!!!"
    echo
    exit 1
fi


name=`cat NAME`

if [ -z "$name" ]; then
    echo 
    echo " FATAL: NAME filen i pakken er tom!"
    echo
    exit 1
fi

cd ..

if [ -d ../$pkgname ]; then
    echo 
    echo " Pakken <$pkgname> er allerede instalert!!"
    echo " Avslutter!"
    echo 
    echo " Hvis du �nsker � instalere pakken p� nytt"
    echo " m� du fjerne katalogen <$pkgname> under .mipkg!"
    echo
    exit 1
fi

if ! mv $pkgname .. ; then
    echo 
    echo " FATAL: Kan ikke flytte pakken fra $mipkgdir/tmp til $mipkgdir!!!"
    echo 
    exit 1
fi

cd ../..

currentpkg=""

if [ -L  .mipkg/$name ]; then
    dummy="$name-$(date '+%Y%m%dT%H%M%S')"
    touch  .mipkg/$name/$dummy
    mypkglist=$(ls -1 ".mipkg")

    for mypkg in $mypkglist ; do
		if [ "$mypkg" = "$name" ]; then
	    	continue
		fi
		if [ -f  .mipkg/$mypkg/$dummy ]; then
	    	currentpkg=$mypkg
		fi
    done

    rm -f  .mipkg/$name/$dummy

    if [  "$currentpkg" ]; then
		echo "$currentpkg er naavarende instalerte pakke av $name"
		echo "Avinstallerer n�v�renede versjon av <$name> ($currentpkg)!"

		if [ -x .mipkg/$currentpkg/mipkg/PKG-UNINSTALL ]; then
	    	.mipkg/$currentpkg/mipkg/PKG-UNINSTALL  .mipkg/$currentpkg
    
	    	if [ "$?" -ne 0 ]; then
				echo
				echo " FATAL: kan ikke avinstallere n�v�rende <$name>"
				echo
				exit 1
	    	fi
		else
	    	echo "WARNING: pakken <$currentpkg> har ingen PKG-UNINSTALL skript"
		fi
    fi
fi

#exit 1

(   cd .mipkg; 
    rm -f $name; 
    ln -s $pkgname $name    
)


if [ -x .mipkg/$pkgname/mipkg/before-PKG-INSTALL ]; then
  
    echo "Running: .mipkg/$pkgname/mipkg/before-PKG-INSTALL .mipkg/$pkgname"
    .mipkg/$pkgname/mipkg/before-PKG-INSTALL .mipkg/$pkgname

    cd $TOP

    if [ "$?" -ne 0 ]; then
 		echo "Failed:"
		if [ "$?" -eq 0 ]; then
	    	rm -rf .mipkg/$pkgname
		fi
	
		exit 1
    fi
fi

.mipkg/$pkgname/mipkg/PKG-INSTALL .mipkg/$pkgname

if [ "$?" -ne 0 ]; then
    echo 
    echo " FATAL: mislykket i � kj�re PKG-INSTALL skriptet!"
    echo " Pakken <$pkgname> ble IKKE vellykket instalert!!!!"
    echo " Pr�v og rull tilbake til forige versjon!!"
    echo 

    .mipkg/$pkgname/mipkg/PKG-UNINSTALL .mipkg/$pkgname

    rm -rf .mipkg/$pkgname
    exit 1
fi


if [ -x .mipkg/$pkgname/mipkg/after-PKG-INSTALL ]; then
  
    echo "Running: .mipkg/$pkgname/mipkg/after-PKG-INSTALL .mipkg/$pkgname"
    .mipkg/$pkgname/mipkg/after-PKG-INSTALL .mipkg/$pkgname

    cd $TOP

    if [ "$?" -ne 0 ]; then
		echo "Failed:"
		
		if [ "$?" -eq 0 ]; then
	    	rm -rf .mipkg/$pkgname
		fi
	
		exit 1
    fi
fi


 echo 
 echo " Pakken <$pkgname> er installert!!!"
 echo
 exit 0


function fatal()
{
    echo 
    echo " FATAL: mislykket i � kj�re INSTALL skriptet!"
    echo " Pakken <$pkgname> ble IKKE vellykket instalert!!!!"
    echo " Pr�v og rull tilbake til forige versjon!!"
    echo 

    exit 1
}

