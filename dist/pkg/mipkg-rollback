#! /bin/sh

pkg_filter=""

if [ -z "$MIPKG_PATH" ]; then
	MIPKG_PATH=$HOME
fi

mipkgdir=${MIPKG_PATH}/.mipkg

if [ ! -d $mipkgdir ]; then
	echo "Ingen mipkg database i katalogen: ${MIPKG_PATH}/.mipkg"
	echo "Trenger du kanskje å sette environment variabelen MIPKG_PATH!"
	exit 1
fi

if [ ! -f $mipkgdir/.lib/mipkg-lib ]; then
	echo "mipkg systemet er ikke satt opp rett!"
	echo "Mangler filen: $mipkgdir/.lib/mipkg-lib"
	exit 1
else
	.  $mipkgdir/.lib/mipkg-lib
fi

if [ -f $mipkgdir/.mipkgrc ]; then
	. $mipkgdir/.mipkgrc
	echo "Leser konfigurasjonsfilen $mipkgdir/.mipkgrc"
fi

function use()
{
    echo ""
    echo " mipkg-rollback  [-a] [-h]"
    echo ""
    echo " mipkg-rollback ruller tilbake/forover til en annen versjon av"
    echo " en gitt pakke!"
    echo ""
    echo "  -a Vis en liste over alle pakkene som er instalert."
    echo "  -h skriv ut denne hjelp teksten og avslutt!"
    echo ""
    exit 1
}

currentdir="$(pwd)"

if ! cd "$MIPKG_PATH" ; then
	echo "Kan ikke skifte til katalogen <$MIPKG_PATH> gitt med MIPKG_PATH!"
	exit 1
fi 

pkglist=""
listallopt=0
OPTERR=0
getopts "ah" opt
optret=$?

while [ $optret -eq 0 ]; do
	case $opt in
		a) listallopt=1;;
		h) use;;
	   \?) echo "Ugyldig option: $OPTARG"; use;;
		*) echo "Uventet, dette skal ikke skje!"; use;;
	esac
   	getopts "ah" opt
  	optret=$?
done

echo "listallopt: $listallopt"

if [ $listallopt -eq 1 ]; then
	pkg_filter=""
fi

echo "pkg_filter: $pkg_filter"

find_installed_package .mipkg "$pkg_filter" pkglist

echo "pkglist: $pkglist"

if [ -z "$pkglist" ]; then
	echo "Ingen pakker er tilgjengelig for å rulles forover eller bakover!"

	if [ $listallopt -eq 0 ]; then
		echo "Prøv å kjør komandoen: mipkg-rollback -a"
	else
		echo "  **** Det finnes ingen pakker i pakke databasen: $mipkgdir ****"
	fi
	
	cd "$currentdir"
	exit 1
fi

pkgname=""

echo "pwd before: $(pwd)"

select_package .mipkg "$pkglist" pkgname

echo "pwd: $(pwd)"
echo "Valgt pakke og versjon  $mipkgdir/$pkgname!"


if [ ! -d ".mipkg/$pkgname" ]; then
    echo "Pakken <$pkgname> er ikke instalert!!!!"
    cd "$currentdir"
    exit 1
fi

if [ -L ".mipkg/$pkgname" ]; then
    echo "Det holder ikke bare med pakkenavnet, version"
    echo "Maa ogsaa angis!"
    cd "$currentdir"
    exit 1
fi


if [ ! -f ".mipkg/$pkgname/NAME" ]; then
    echo "File <$mipkgdir/$pkgname/NAME> finnes ikke!"
    cd "$currentdir"
    exit 1
fi

name=$(cat .mipkg/$pkgname/NAME)

echo "NAME $name"

currentpkg=""

if [ -L  ".mipkg/$name" ]; then
    dummy="dummy-$(date '+%Y%m%dT%H%M%S')"
    
    touch  .mipkg/$pkgname/$dummy

    if [ -f  .mipkg/$name/$dummy ]; then
		currentpkg=$pkgname
    fi

    if [  "$currentpkg" ]; then
		echo "Du kan ikke gjore en rollback til samme pakke!"
		cd "$currentdir"
		exit 1
    fi
    
    if [ -x .mipkg/$name/mipkg/PKG-UNINSTALL ]; then
		.mipkg/$name/mipkg/PKG-UNINSTALL  .mipkg/$name
    
		if [ "$?" -ne 0 ]; then
	    	echo
	    	echo " FATAL: kan ikke avinstallere nåværende <$name>"
	    	echo
	    	cd "$currentdir"
	    	exit 1
		fi

    else
		echo "WARNING: pakken <$name> har ingen PKG-UNINSTALL skript"
    fi


    if [ -x .mipkg/$pkgname/mipkg/PKG-INSTALL ]; then
		.mipkg/$pkgname/mipkg/PKG-INSTALL  .mipkg/$pkgname
	
		if [ "$?" -ne 0 ]; then
	    	echo
	    	echo " FATAL: kan ikke innstallere  <$pkgname>"
	    	echo
	    	cd "$currentdir"
	    	exit 1
		fi

    else
		echo "WARNING: pakken <$name> har ingen PKG-INSTALL skript"
    fi
    
    if cd .mipkg ; then 
   	 	rm -f $name 
    	ln -s $pkgname $name    
		cd ..
	fi
    
else
    echo "Pakken <$name> er ikke installert!"
    cd "$currentdir"
    exit 1
fi

echo 
echo "Pakken <$name> er rullet tilbake til $pkgname"
echo 

cd "$currentdir"

exit 0




