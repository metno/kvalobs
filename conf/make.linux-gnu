# This file contains common setup for compiler, OMNIORB, postgresql, 
# BOOST and PERL. It is defined five variables that control where we 
# shall look for this common tools. They are:
# GCCBIN       - where is gcc installed. PATH is used for default search
#                after gcc and g++. To override this default, define GCCBIN
#                in your environment.
# OMNIORB_HOME - Where shall we look for OMNIORB. Default value is
#                defined in this file. To override this default 
#                define OMNIORB_HOME in your environment.
# BOOST_HOME   - Where shall we look for BOOST. Default value is
#                defined in this file. To override this default define 
#                BOOST_HOME in your environment.
# POSTGRESQL_HOME - Where is postgresql installed. Default /usr/local/pgsql
# SQLITEINCLUDE   - Where is the header files to sqlite.
# SQLITELIB       - Where is the sqlite library files.
#
# PERL_BIN     - Where is PERL. To override this default define
#                PERL_BIN in your environment.
# QTDIR        - Where is qt installed.
#
# Where can we find the tools we depend on. 
# gcc        - http://gcc.gnu.org
# BOOST      - http://www.boost.org
# OMNIORB    - http://www.omniorb.org
# postgresql - http://www.postgresql.org
# qt         - http://www.trolltech.com
# sqlite     - http://www.sqlite.org
# libxml2    - http://www.xmlsoft.org
# libxml++   - http://libxmlplusplus.sourceforge.net (Version 1.0)
# puTools    - Internt utviklet bibliotek for tid og dato klasser.
# cppUnit    - http://cppunit.sf.net

#Har vi en lokal configurasjonsfil sï¿½ bruk den

ifndef TOP
  TOP= $(KVDIR)
endif

MYCONF=$(TOP)/conf/myconf

ifeq ($(wildcard $(MYCONF)),$(MYCONF))
include $(MYCONF)
endif

ifndef PUTOOLS
	PUTOOLS=/usr/local
endif 

#Where shall we install this program package.
LOCALDIR=/usr/local


#Default for where to install lib / include for libraries ....

INCTO=$(TOP)/include/$(LIBNAME)
INCFROM=include

LIBFROM=obj
LIBTO=$(TOP)/lib
IIGNORE=

TOBIN:=$(TOP)/bin

# Platform suffix
PLT=

ifdef SQLITEINCLUDE
  ifndef SQLITEINCLUDE_DEFINED
    SQLITEINCLUDE:= -I$(SQLITEINCLUDE)
    SQLITEINCLUDE_DEFINED=1
    export SQLITEINCLUDE_DEFINED
  endif
endif

ifdef SQLITELIB
  ifndef SQLITELIB_DEFINED
    SQLITELIB:= -L$(SQLITELIB) -lsqlite
    SQLITELIB_DEFINED=1
    export SQLITELIB_DEFINED
  endif
endif

ifndef QTDIR
    QTDIR=/usr/local/qt
endif

ifndef QT_INCLUDE
   QT_INCLUDE=$(QTDIR)/include
endif

ifndef QT_LIB
   QT_LIB=$(QTDIR)/lib
endif

#Where is postgresql installed
ifndef POSTGRESQL_HOME
POSTGRESQL_HOME:=/usr/local/pgsql
endif


#Where is BOOST and OMNIORB installed
ifndef OMNIORB_HOME
OMNIORB_HOME:=/usr/local
endif

ifndef BOOST_HOME
BOOST_HOME:=/usr/local
endif

#CORBA library for java
ifndef JACORB_HOME
JACORB_HOME:=$(HOME)/jacorb
endif

JACORBJAR:=$(JACORB_HOME)/lib/jacorb.jar
IDLJAVA:=$(JACORB_HOME)/bin/idl

export JACORB_HOME JACORBJAR IDLJAVA


#JAVA compiler 
ifdef JAVA_HOME
JAVAC:=$(JAVA_HOME)/bin/javac
JAVADOC:=$(JAVA_HOME)/bin/javadoc
else
JAVAC:=javac
JAVADOC:=javadoc
endif

export JAVADOC JAVAC

ifndef CXX
  ifdef GCCBIN
    GCCBIN:=$(GCCBIN)/
    GCCBIN:=$(subst //,/,$(GCCBIN))
  else
    GCCBIN:=/usr/local/bin/
  endif

  CXX=$(GCCBIN)g++
  CC=$(GCCBIN)gcc
endif

#Where is perl installed
####PERL_HOME:=/usr/lib/perl/5.6.1
####PERL_HOME:=/usr/local/lib/perl5/5.8.0

ifndef PERL_BIN
  PERL_BIN:=perl
endif


#dummy:
#	@echo 'GCCBIN=$(GCCBIN)'
#	@echo 'POSTGRESQL_HOME=$(POSTGRESQL_HOME)'

LEX=flex


#dummy:
#	@echo 'GCCBIN=$(GCCBIN)'
#	@echo 'POSTGRESQL_HOME=$(POSTGRESQL_HOME)'
#	@echo 'CXX=$(CXX)'
#	@echo 'CC=$(CC)'


#IDLCXX og IDLCXXANY angir hvilke idl-kompilator som skal brukes!
ifndef OMNIORB_BIN
   OMNIORB_BIN=$(OMNIORB_HOME)/bin
endif

IDLCXX=$(OMNIORB_BIN)/omniidl -bcxx -Wbexample
IDLCXXANY=$(OMNIORB_BIN)/omniidl -bcxx -Wba

AR=ar
ARFLAGS=-cr

COMMONFLAGS=-g 

# Which flag must be set for shared libs.
CXXSOFLAGS=-fPIC
CXXLDSOFLAGS=-shared 

#If we loads shared object with dlopen we must use extra link option when
#linking our programs. This is for g++ compiled shared objects.
#See the gcc FAQ at http://gcc.gnu.org/faq.html for a further explenation.
CXXLINKSO=$(COMMONFLAGS) -Wl,-E



# CXX-flags
CXXFLAGS=  $(COMMONFLAGS) -pthread 
CXXLDFLAGS=$(COMMONFLAGS) -pthread

# C-flags
CFLAGS=   $(COMMONFLAGS) -pthread
CLDFLAGS= $(COMMONFLAGS) -pthread


# Some includes
XINCLUDE= -I/usr/X11R6/include
GLINCLUDE=-I/usr/local/include
FTINCLUDE=-I/usr/local/include
GLTTINCLUDE=-I/usr/local/include/gltt
BOOSTINCLUDE=-I$(BOOST_HOME)/include

ifndef OMNIORB_INCLUDE
	OMNIINCLUDE:=$(strip $(shell pkg-config --cflags-only-I omniORB4))/omniORB4
#  OMNIINCLUDE:=$(OMNIINCLUDE)/omniORB4 
  	OMNIINCLUDE:=$(shell pkg-config --cflags omniORB4) $(OMNIINCLUDE)
#  OMNIINCLUDE= -I$(OMNIORB_HOME)/include/omniorb \
#	             -I$(OMNIORB_HOME)/include/omniorb/omniORB4
else
  OMNIINCLUDE= -I$(OMNIORB_INCLUDE) -I$(OMNIORB_INCLUDE)/omniORB4 
endif

ifndef PSQL_INCLUDE
  POSTGRESINCLUDE=-I$(POSTGRESQL_HOME)/include \
	          -I$(POSTGRESQL_HOME)/include/pgsql
else
  POSTGRESINCLUDE=-I$(PSQL_INCLUDE)
endif

#Compile options to perl.
PERLCCOPTS:=$(shell $(PERL_BIN) -MExtUtils::Embed -e ccopts)

#Remove /usr/local/include, it only makes problem with the current
#setup with a totaly broken gcc compiler and libs compiled with it. 
PERLCCOPTS:=$(filter-out -I/usr/local/include, $(PERLCCOPTS))


# Where is the libs...
ifndef PSQL_LIB
  POSTGRESLIB=-L$(POSTGRESQL_HOME)/lib
else
  POSTGRESLIB=-L$(PSQL_LIB)
endif

ifndef OMNIORB_LIB
  OMNILIB:=$(shell pkg-config --libs omniORB4)
  #OMNILIB=-L$(OMNIORB_HOME)/lib
else
  OMNILIB=-L$(OMNIORB_LIB)
endif

BOOSTLIB=-L$(BOOST_HOME)/lib

#Link options to perl
PERLLIBS:=$(shell $(PERL_BIN) -MExtUtils::Embed -e ldopts)

#Remove /usr/local/lib, it only makes problem with the current
#setup with a totaly broken gcc compiler and libs compiled with it. 
PERLLIBS:=$(filter-out -L/usr/local/lib , $(PERLLIBS))

LIBXML_INCLUDE:=$(shell pkg-config libxml-2.0 --cflags)
LIBXML_LIB:=$(shell pkg-config libxml-2.0 --libs)
LIBXML_LIB:=$(filter-out -lpthread, $(LIBXML_LIB))
LIBXML_LIB:=$(filter-out -lz, $(LIBXML_LIB))
LIBXML_LIB:=$(filter-out -lm, $(LIBXML_LIB))
LIBXML_LIB:=-Wl,-Bstatic $(LIBXML_LIB) -Wl,-Bdynamic -lz -lm


LIBXMLPPINCLUDE=$(shell pkg-config libxml++-1.0 --cflags)
LIBXMLPPLIB:=$(shell pkg-config libxml++-1.0 --libs)
LIBXMLPPLIB:=$(filter-out -lz , $(LIBXMLPPLIB))
LIBXMLPPLIB:=$(filter-out -lm , $(LIBXMLPPLIB))
LIBXMLPPLIB:=$(filter-out -lpthread , $(LIBXMLPPLIB))
LIBXMLPPLIB:=-Wl,-Bstatic $(LIBXMLPPLIB) -Wl,-Bdynamic -lz -lm

export OMNIINCLUDE BOOSTINCLUDE POSTGRESINCLUDE PERLCCOPTS
export POSTGRESLIB OMNILIB BOOSTLIB PERLLIBS QTDIR QT_INCLUDE QT_LIB
export SQLITEINCLUDE SQLITELIB LIBXMLPPINCLUDE LIBXMLPPLIB
export LIBXML_LIB LIBXML_INCLUDE