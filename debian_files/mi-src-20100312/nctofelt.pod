=head1 NAME

nctofelt

=head1 PURPOSE

Convert from netcdf format to FELT file format

=head1 USAGE

   nctofelt -d fdef netcdffile feltfile <specification_file

where I<fdef> is the name of a flt2flt grid definition file.
The -d option is now mandatory. No default I<fdef> file is assumed.

=head1 DESCRIPTION

Selected fields from the netcdf file are transferred to a FELT
file, which will be created.

=head2 Specification file (standard input)

The nctofelt command reads a specification from standard input
on how to convert from the netcdf file to the FELT file.
The specification contains a description of which variables in
the netcdf file are to be transferred to the FELT file, and how
corresponding fields in the two files are identified.

The following sections gives details about the specification file.

B<NOTE:> A FELT file may contain fields for different B<date/time> 
values. These are the values given as the first argument to the FELT(...)
specification (described below). In addition, for one date/time value,
there may be several fields corresponding to different B<forecast length>s.
Special rules applies regarding the date/time values that may be used in a
FELT file. See details in B<NOTE about date/time> below.

=head2 Line one

The first line in the specification file contains the following 10
whole numbers:

=over 4

=item *

The number of two-dimensional FELT fields to be produced.
This number is also equal to the number of lines comprising
the rest of the file.

=item *

The type of the FELT file (999,998 or 997). Normally, type=998 will be the
most useful one.
   999 = standard felt file (one date/time value)
   998 = archive felt file (several date/time values)
   997 = cyclic archive felt file (several date/time values)

=item *

Producer number. This utility only allows one producer in the 
FELT file. This number has only a descriptive function. Any
number in the range 1 - 99 will work.

=item *

Three numbers giving the B<base date/time> for the data 
(corresponding to word 5-7, record 1 in a standard FELT file;
corresponding to the first date/time for an archive FELT file).
(Year, month*100+day, hour*100+minute).

=item *

Number of date/time values in the FELT file (FELT record 1 word 26)
(for standard, type=999 FELT files, this can only be 1).

=item *

Number of index slots in "innholdsfortegnelse" per date/time value
(FELT record 1 word 27). This must correspond to the maximum
number of 2D fields to be converted for one date/time value.

=item *

Unit for date/time resolution (1=year, 2=month, 3=day, 4=hour,
5=minute) (FELT record 1 word 29)

=item *

Length of time step between consecutive date/time values
(using unit as above) (FELT record 1 word 30)

=back

=head2 Following lines

Then follows lines of the following type:

   FELT(date,grid,dtyp,fcl,lev1,lev2,vco,par) = varname(arg1,arg2,...)<LC>

<LC> is an optional linear conversion clause (see L<"Linear conversion"> below).

The I<date> field is optional. So, an alternative form is:

   FELT(grid,dtyp,fcl,lev1,lev2,vco,par) = varname(arg1,arg2,...)<LC>

Each line describes one two-dimensional field in the FELT file,
and the variable in the netcdf file from where the data are to be
transferred.

The words I<date,grid,dtyp,fcl,lev1,lev2,vco,par,varname,arg1,arg2,...>
should be substituted by the following values:

=over 4

=item date 

(Optional). Date/time on the form: YYYY-MM-DD:HHMM
If not given, then the date/time given in line one
(for a standard, type=999 FELT file) is used. Othervise,
the date/time for the previous field is used.
See also: L<"NOTE about date/time"> below.

=item grid 

Grid area
This is the grid number described in felt.txt.
The grid number must be found in the flt2flt grid
definition file given by the '-d' option on
the command line.
This value may also take the form B<gn:x1-x2:y1-y2>,
where gn = grid number,
x1 = initial x index, x2 = final x index and y1, y2 =
the initial and final y indices. The initial x,y indices
represent the indices in the resulting FELT array
corresponding to the first value copied from the
netcdf variable. x1,y1 defaults to 1,1. The final
x,y indices correspond to the last value copied from
the netcdf variable. When x1-x2, y1-y2 is
explisitly given as two integer ranges,
only the rectangular part of the FELT
array given by taking (x1,y1) as the lower left
and (x2,y2) as the upper right corner,
is filled with values. The other parts of the FELT
array is filled with the missing value code.

If the initial index is larger than the final index
(i.e. x1 > x2 or y1 > y2), then the corresponding
axis is turned in the opposite direction.
This effect may also be obtained by using a '-'
before one or both of the '#'-arguments of the
netCDF array description (see below).

=item dtyp 

Data type (1,2,3 or 4 - described in felt.txt)
   1  :  Analysis fields
   2  :  Prognostic fields
   3  :  Computed/interpolated/initialized fields
   4  :  Parameter fields
 
=item fcl 

Forecast length (hours). For fields other than prognostic fields,
this number should be 0. For prognostic fields, added to
the date/time given in I<date> above, this number represents
the valid time for the physical state described by the 2D field.

=item lev1 

Level 1 vertical co-ordinate value in units corresponding to 
I<vco> below.

=item lev2 

Level 2 vertical co-ordinate value (=0 if the level can be
described by only one value).

=item vco 

Type of vertical co-ordinate used:
     1  :  Pressure (hPa)
     2  :  sigma atmosphere
     3  :  h
     4  :  theta (isentropical surfaces)
     5  :  z (depth, ocean)
     6  :  level (ocean)
     7  :  sigma ocean
     8  :  surface of the earth/oceans
     9  :  pv, potential vorticity
    10  :  eta (hybrid) atmosphere
    11  :  "sigma height" = (Z-Zs)/(H-Zs), (H: height in meter)
    (Descriptions taken from felt.txt)

=item par 

Parameter code. (Described in felt.txt)

=item variable 

Variable name identifying an array in the netcdf file

=item arg1,... 

Arguments to define which part of the netcdf array
to use. 

These arguments may either have values
found for the corresponding dimension in the
netcdf file, or they have the special values B<#1> or B<#2>.
Exactly one of the arguments must have the value
#1. Another argument may have the value #2.
If only the #1 argument is found, the two-dimensional
field is defined by varying the array index
corresponding to the #1 argument from 1 up to the
size of the dimension. If both the #1 and #2
arguments are given, then values are copied from
the netcdf array by first setting the #2 index
to 1 while traversing all values of the #1 index
from 1 and up to the dimension size, then setting
the #2 index to 2 etc.

If both #1 and #2 are used, each of these arguments
may be prepended by '-', i.e. '-#1' and/or '-#2'.
The effect of this will be that copying is
initiated from the last netCDF array index. The
index is decremented by one for each copied value,
and ends up as 1. The sequence by which values are
put into the FELT file is not changed, so the
net effect will be to turn the 2D field upside
down, or create a field which is a mirror image
of the normal field. If both '-#1' and '-#2' are
used, the effect will be to rotate the 2D field
180 degrees.

If the argument is neither #1 or #2, it either
corresponds to an index value in the netcdf array,
or to a value found in another netcdf variable
having the same name as the dimension corresponding
to the argument. If such dimension variable exists,
this alternative is the only possibility. Care
should be taken to make unambiguous arguments
corresponding to values in a dimension variable.
If this variable is of type float or double, the
argument should always include a decimal point.

The 2D FELT field, which is produced, may be seen
as a 2D array a(x,y) where the x index corresponds
to the #1 argument and y corresponds to the #2
argument. For lat-lon grids, x (and #1) correspnds to
the longitude dimension, while y (and#2)  corresponds to the
latitude dimension.

=back

=head2 Linear conversion

The optional linear conversion clause, <LC>, is used if the values
in the netcdf file are to be transformed by a linear function before
they are stored in the FELT file. This clause must correspond to one
of the following forms:

   * r1
   * r1 + r2
   * r1 - r2
   + r2
   - r2

where r1 and r2 are numbers (with or without a decimal
point and optionally using a scientific notation as in 2.0e-5).
Both r1 and r2 may be prepended by a sign if enclosed in parantheses
(like: (-5.9)).
Spaces as shown in the forms above are not neccessary.

=head2 NOTE about date/time

The number of lines corresponding to one date/time value must
not exceed the available number of index slots in the
"innholdsfortegnelse" for the given date/time value. This 
number is given on line one (described above).

Also, lines must be sorted in incresing date/time order, and
each date/time must correspond to one of the date/times
defined in line one ('base date/time' + n * 'time step',
n = 0,1,2,...).
